<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Questions Multiplayer — Jogo</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="game.css" />
</head>
<body>
  <div id="game-container">
    <header id="top-bar">
      <div id="room-info">
        <span>Sala: <b id="roomName">Carregando...</b></span>
        <span>Modo: <b id="mode">Normal</b></span>
        <span>Pergunta <b id="currentIndex">1</b>/<b id="totalQuestions">10</b></span>
      </div>
      <button id="btn-settings" class="btn small">Configurações</button>
    </header>

    <main id="game-area">
      <div id="timer">20</div>
      <h2 id="question-text">Carregando pergunta...</h2>
      <div id="answers"></div>
    </main>

    <footer id="footer-bar">
      <div id="status">Aguardando...</div>
      <div id="score-board">Pontuação: <b id="score">0</b></div>
    </footer>
  </div>

  <!-- Modal Configurações -->
  <div id="settings-modal" class="modal hidden">
    <div class="modal-content">
      <h2>Configurações</h2>
      <button class="btn full" id="btn-exit">Sair da sala</button>
      <button class="btn ghost full" id="btn-close-settings">Voltar</button>
    </div>
  </div>

  <script src="ui.js"></script>
  <script src="api.js"></script>
  <script src="generator.js"></script>
  <script src="game.js"></script>

  <script>
    // Recebe os parâmetros da URL (funciona para demo ou sala real)
    const url = new URL(location.href);
    const room = url.searchParams.get('room') || 'demo';
    const password = url.searchParams.get('password') || 'demo';
    const mode = url.searchParams.get('mode') || 'normal';
    const totalQuestions = parseInt(url.searchParams.get('questions') || 10);
    const timePerQuestion = parseInt(url.searchParams.get('time') || 20);

    document.getElementById('roomName').textContent = room;
    document.getElementById('mode').textContent = mode;
    document.getElementById('totalQuestions').textContent = totalQuestions;

    // Inicializa variáveis do jogo
    let currentIndex = 1;
    let score = 0;

    function startGame() {
      carregarNovaPergunta();
    }

    function carregarNovaPergunta() {
      const p = gerarPergunta();
      document.getElementById('question-text').textContent = p.pergunta;
      const answersBox = document.getElementById('answers');
      answersBox.innerHTML = '';

      p.alternativas.forEach(alt => {
        const btn = document.createElement('button');
        btn.textContent = alt;
        btn.onclick = () => verificarResposta(alt, p.correta);
        answersBox.appendChild(btn);
      });

      // Timer simples
      const timerEl = document.getElementById('timer');
      let time = timePerQuestion;
      timerEl.textContent = time;
      const interval = setInterval(() => {
        time--;
        timerEl.textContent = time;
        if (time <= 0) {
          clearInterval(interval);
          verificarResposta(null, p.correta); // Timeout conta como erro
        }
      }, 1000);
    }

    function verificarResposta(escolhida, correta) {
      if (escolhida === correta) {
        score += 10;
        showToast('✅ Correto!', 'success');
      } else {
        showToast(`❌ Errado! Resposta certa: ${correta}`, 'error');
      }

      document.getElementById('score').textContent = score;
      currentIndex++;

      if (currentIndex > totalQuestions) {
        // fim do jogo
        const endPage = score >= totalQuestions * 5 ? 'victory.html' : 'defeat.html';
        changeScreen(`${endPage}?score=${score}`);
      } else {
        document.getElementById('currentIndex').textContent = currentIndex;
        carregarNovaPergunta();
      }
    }

    // Inicia o jogo
    startGame();
  </script>
</body>
</html>
